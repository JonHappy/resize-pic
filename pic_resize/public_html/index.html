<!DOCTYPE html>
<!--  http://habrahabr.ru/post/112286/  -->


<html>
    <head>
        <link rel="icon" href="pic/favicon.ico" type="image/x-icon">
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>PIC</title>
        <script src="js/libs/jquery/jquery.min.js" type="text/javascript"></script>

        <script src="js/libs/jquery-mousewheel/jquery.mousewheel.min.js" type="text/javascript"></script>
        <script src="js/jquery-ui.min.js" type="text/javascript"></script>
        <!--</script> http://webext.ru/fix-mousewheel/-->
        <link href="CSS/pic.css" rel="stylesheet" type="text/css"/>
        <style>
            #label_h{margin-left: 4px;}
            #label_w{margin-left: 4px;}
            #name_file{
                width: 139px;
                /*background: aquamarine;*/
                height: 18px;
                display: inline-block;
                padding-left: 3px;
                vertical-align: bottom;
            }
        </style>
    </head>
    <div id="div1">
        <hr id="v_line">
        <hr id="h_line">
        <div id="crop"><div></div></div>
        <img id="img" src="" alt=""/>
    </div>
    <div>
        <input  id="rotate" type="range" value="0" min="-180" max="180" step="1">
    </div>
    <div id="right_mark"><div id="mark"></div></div>
    <div id="bottom_mark"><div id="mark_b"></div></div>
    <div id="size_mark"><div id="mark_s"></div></div>
    <input type="file" id="file" multiple accept="image/jpeg">
    <div id="name_file"></div>
    <button id="crop_button"  disabled="">обрезать</button>
    <!--<button id="c1">full/preview</button>-->
    <button id="c2"><span>x</span>/<span>xx</span></button>
    <button id="save" disabled="" >Сохранить</button>
    <button id="arrow_v" class="arrow_vh"></button>
    <button id="arrow_h"  class="arrow_vh"></button>
    <label id="label_h">h <span id="h_crop"></span></label>
    <label id="label_w">w <span id="w_crop"></span></label>

    <div class="cropped"></div>

    <script>

            var pics = {
                full_height: 300,
                full_width: 300,
                preview_height: 70,
                preview_width: 70
            };
            var matrix = new Array(6);
            var current_img = {
                top: 0,
                left: 0,
                x: 0,
                y: 0,
                height: 0,
                width: 0
            };
            var new_img = {
                top: 0,
                left: 0,
                x: 0,
                y: 0,
                height: 0,
                width: 0
            };
            var img = {
                height: 0,
                width: 0,
                rotate: 0,
                scale: 1
            };
            var id_crop = ['preview', 'full'];
            var crop = {
                height: pics.full_height,
                width: pics.full_width,
                id: id_crop[1]
            };
            document.querySelector('#w_crop').innerHTML = crop.width;
            document.querySelector('#h_crop').innerHTML = crop.height;
            var Cy = $('#div1').height() / 2;
            var Cx = $('#div1').width() / 2;
            $('#crop').css({
                height: crop.height,
                width: crop.width,
                top: Cy - crop.height / 2,
                left: Cx - crop.width / 2
            });
            var x_xx = 0.01;
            var cropImg = 0;
            var deg_to_rad = Math.PI / 180;
            var rad_to_deg = 180 / Math.PI;

            function tr_or() {
                var dx = new_img.left - current_img.left;
                var dy = new_img.top - current_img.top;
                var beta = Math.atan2(dx, dy);
                var alfa = img.rotate * deg_to_rad;
                var len = (Math.sqrt(dx * dx + dy * dy));
                new_img.x = current_img.x - len * Math.sin(beta + (alfa));
                new_img.y = current_img.y - len * Math.cos(beta + (alfa));
                new_img.top = (Cy - new_img.y);
                new_img.left = (Cx - new_img.x);
                set_css_img();
                current_img.x = new_img.x;
                current_img.y = new_img.y;
            }

//            -- переключатель full/preview --
//                $(document).on('click', '#c1', function () {
//                    if (crop.height === pics.preview_height)
//                    {
//            -- включение режима full --
//                        $('#bottom_mark').css('display', 'block');
//                        $('#mark_b').css('top', '0px');
////                    $('#h_line').css('top', '-10px');
//                        $('#h_line').css('display', 'block').css('top', '-10px');
//                        crop.height = pics.full_height;
//                        crop.width = pics.full_width;
//                        crop.id = id_crop[1];
//                        $('#c1').attr('data-v', crop.id);
//                        img.scale = pics.full_width / img.width;
//                        setres(0);
//                        $('#crop').css({
//                            height: crop.height,
//                            width: crop.width,
//                            left: Cx - crop.width / 2,
//                            top: Cy - crop.height / 2
//                        });
//
//                    }
//                    else
//                    {
//            -- включение режима preview --
//                        $('#bottom_mark').css('display', 'none');
//                        $('#h_line').css('display', 'none');
//                        crop.width = crop.width / crop.height * pics.preview_height;
//                        var k = crop.height / pics.preview_height;
//                        crop.height = pics.preview_height;
//                        crop.id = id_crop[0];
//                        $('#c1').attr('data-v', crop.id);
//                        img.scale /= k;
//                        setres(0);
//                        $('#crop').css({
//                            height: crop.height,
//                            width: crop.width,
//                            left: Cx - crop.width / 2,
//                            top: Cy - crop.height / 2
//                        });
//                    }
//                    $('#v_line').css({
//                        left: $('#crop').width() / 2 + 2
//                    });
//                    $('#mark').css({
//                        left: $('#crop').width() / 2 + 2
//                    });
//
//
//                });
//        -- назначение пермещения --


            $(document).ready(function () {
//
//                var cellIndex = window.opener.document.getElementsByTagName('my-AirTest')[0].dataset['sample'];
//                if (cellIndex !== "-")
//                {
//                    document.getElementById('file').removeAttribute('multiple');
//                }


                $(document).keydown(function (event) {
                    var k = event.keyCode || event.charCode;
                    switch (k)
                    {
                        case 16:
                            window.shiftDown = true;
                            $('#arrow_h').css('background-image', 'url(pic/arrow_h_red.png)');
                            break;
                        case 17:
                            $('#arrow_v').css('background-image', 'url(pic/arrow_v_red.png)');
                            window.ctrlDown = true;
                            break;
                    }

                });
                $(document).keyup(function (event) {
                    var k = event.keyCode || event.charCode;
                    switch (k)
                    {
                        case 16:
                            $('#arrow_h').css('background-image', 'url(pic/arrow_h_green.png)');
                            window.shiftDown = false;
                            break;
                        case 17:
                            $('#arrow_v').css('background-image', 'url(pic/arrow_v_green.png)');
                            window.ctrlDown = false;
                            break;
                    }

                });



                $('#img').draggable({
                    stop: function (event, ui) {
                        if (!window.xx)
                        {
                            current_img.top = ui.originalPosition.top;
                            new_img.top = ui.position.top;
                        }
                        if (!window.yy)
                        {
                            current_img.left = ui.originalPosition.left;
                            new_img.left = ui.position.left;
                        }
                        console.log(new_img.left);
                        tr_or();
                    },
                    start: function (event, ui) {
                        window.yy = false;
                        window.xx = false;
                        if (window.shiftDown)
                        {
                            window.yy = true;
                            current_img.left = ui.originalPosition.left;
                            new_img.left = ui.position.left;
                            $('#img').draggable("option", "axis", "y");
                        }
                        if (window.ctrlDown)
                        {
                            window.xx = true;
                            current_img.top = ui.originalPosition.top;
                            new_img.top = ui.position.top;
                            $('#img').draggable("option", "axis", "x");
                        }

                        if (!window.xx & !window.yy)
                        {
                            $('#img').draggable("option", "axis", false);
                        }
                    }

                });

//                $('#v_line').draggable({
//                    axis: "x",
//                    drag: function (event, ui) {
//                        crop.width = ui.position.left * 2;
//                        $('#crop').css({
//                            height: crop.height,
//                            width: crop.width,
//                            left: Cx - crop.width / 2 - 1,
//                            top: Cy - crop.height / 2 - 1
//                        });
//                    }
//                });
                $('#v_line').css({
                    left: $('#crop').width() / 2,
                    top: 0
                });
                $('#mark').css({
                    left: $('#crop').width() / 2
                });
                $('#mark_b').css({
                    top: document.getElementById('crop').offsetTop
                });
                $('#h_line').css({
                    left: 0,
                    top: document.getElementById('crop').offsetTop
                });
//                    $('#c1').attr('data-v', crop.id);
                var v = 0;
                $('#mark_s').draggable({
                    axis: "y",
                    containment: "parent",
                    drag: function (event, ui) {
                        var t = 345 - ui.position.top;
                        setres(v < t ? x_xx : -x_xx);
                        v = t;
                    },
                    revert: true,
                    revertDuration: 30
                });


                $('#mark').draggable({
                    axis: "x",
                    containment: "parent",
                    drag: function (event, ui) {
                        crop.width = ui.position.left * 2;
                        $('#crop').css({
                            height: crop.height,
                            width: crop.width,
                            left: Cx - crop.width / 2 - 1,
                            top: Cy - crop.height / 2 - 1
                        });
                        $('#v_line').css({
                            left: $('#crop').width() / 2,
                            top: 0
                        });
                        document.querySelector('#w_crop').innerHTML = crop.width;
                    }
                });
                $('#mark_b').draggable({
                    axis: "y",
                    containment: "parent",
                    drag: function (event, ui) {
                        crop.height = 2 * (Cy - ui.position.top) - 2;
                        $('#crop').css({
                            height: crop.height,
                            width: crop.width,
                            left: Cx - crop.width / 2 - 1,
                            top: Cy - crop.height / 2 - 1
                        });
                        $('#h_line').css({
                            top: ui.position.top,
                            left: 0
                        });
                        document.querySelector('#h_crop').innerHTML = crop.height;
                    }
                });
                $('#c2 span:eq(1)').css('color', '#00ff00');

            });

//        -- запрет перемещения --
            $(document).on('click', '#arrow_h', function () {
                if (window.xx)
                {
                    $('#arrow_h').css('background-image', 'url(pic/arrow_h_red.png)');
                }
                else
                {
                    $('#arrow_h').css('background-image', 'url(pic/arrow_h_green.png)');
                }
                window.xx = !window.xx;
            });
//        -------------------------- скорость ресайза --------------------------------------
            $(document).on('click', '#c2', function () {
                if (x_xx === 0.001)
                {
                    $('#c2 span:eq(1)').css('color', '#00ff00');
                    $('#c2 span:eq(0)').css('color', '#000000');
                    x_xx = 0.01;
                }
                else
                {
                    $('#c2 span:eq(0)').css('color', '#00ff00');
                    $('#c2 span:eq(1)').css('color', '#000000');
                    x_xx = 0.001;
                }
            });

//        -- ресайз --
            $('#div1').mousewheel(function (event, delta) {
                setres(delta > 0 ? x_xx : -x_xx);
            });

            function setres(p) {
                img.scale += p;

                var new_h = img.height * img.scale;
                new_img.x = new_img.x * new_h / new_img.height;
                new_img.height = new_h;

                var new_w = img.width * img.scale;
                new_img.y = new_img.y * new_w / new_img.width;
                new_img.width = new_w;

                current_img.x = new_img.x;
                current_img.y = new_img.y;
                new_img.top = (Cy - new_img.y);
                new_img.left = (Cx - new_img.x);
                set_css_img();
            }

            function set_css_img() {
                var ang = -1 * img.rotate * deg_to_rad;
                matrix[0] = Math.cos(ang);
                matrix[1] = -1 * Math.sin(ang);
                matrix[2] = Math.sin(ang);
                matrix[3] = Math.cos(ang);
                matrix[4] = 0;
                matrix[5] = 0;

                $('#img').css({
                    'width': (img.width * img.scale),
                    'height': (img.height * img.scale),
                    'transform-origin': new_img.x + 'px ' + new_img.y + 'px',
                    'top': new_img.top,
                    'left': new_img.left,
                    'transform': 'matrix(' + matrix.join(',') + ')'
                });
            }

//        -- поворот ползунком --
            $(document).on('input', '#rotate', function () {
                img.rotate = parseInt($('#rotate').val());
                set_css_img();
            });

//        -- поворот колесом мыши --
            $('#rotate').mousewheel(function (event, delta) {
                img.rotate = parseInt($('#rotate').val());
                img.rotate += delta > 0 ? 1 : -1;
                $('#rotate').val(img.rotate);
                set_css_img();
            });

//        -- загрузка файла --
            var fb = [];
            var work;
            document.querySelector('#file').addEventListener('change', function () {
                work = work_(this.files);
            }, false);

//загрузка перетаскиванием
//            var target = document.getElementById("div1");
//            target.addEventListener("dragover", function (event) {
//                event.preventDefault(); // отменяем действие по умолчанию
//            }, false);
//            target.addEventListener("drop", function (event) {
//                // отменяем действие по умолчанию
//                event.preventDefault();
//                var files = event.dataTransfer.files;
//                var n = files.length;
//                var g = n;
//                for (var i = 0; i < n; i++) {
//                    var reader = new FileReader();
//                    reader.onload = function (e) {
//                        var pic = new Image();
//                        pic.onload = function () {
//                            fb.push(pic);
//                            if (g === 0)
//                            {
//                                work();
//                            }
//                        };
//                        pic.src = e.target.result;
//
//                    };
//                    reader.readAsDataURL(event.dataTransfer.files[i]);
//                }
//            }, false);




            function work_(fa) {
                var failesArray = fa;
                var n = 0;
                var a = failesArray.length;
                vvv(failesArray[n++]);
                var el_img = document.getElementById('img');
                var urlFactory = window.URL || window.webkitURL;
                function vvv(file) {
                    var reader = new FileReader();
                    reader.onload = function () {
                        console.timeEnd('чтение');
                        document.getElementById('crop_button').removeAttribute('disabled');
                        var pic = new Image();
                        pic.onload = function () {
                            document.querySelector('#name_file').innerHTML = n + ' ' + file.name;
                            console.timeEnd('запись');
                            console.time('показ');
                            el_img.setAttribute('src', pic.src);
                            console.timeEnd('показ');
                            img.scale = 700 / parseInt(pic.width);
                            img.height = parseInt(pic.height);
                            img.width = parseInt(pic.width);
                            var h = img.height * img.scale;
                            var w = img.width * img.scale;
                            el_img.style.height = h + 'px';
                            el_img.style.width = w + 'px';
                            current_img.height = h;
                            current_img.width = w;
                            new_img.height = h;
                            new_img.width = w;
                            current_img.top = 0;
                            current_img.left = 0;
                            new_img.top = 0;
                            new_img.left = 0;
                            current_img.x = $('#div1').width() / 2;
                            current_img.y = $('#div1').height() / 2;
                            new_img.x = $('#div1').width() / 2;
                            new_img.y = $('#div1').height() / 2;

                            img.rotate = 0;
                            tr_or();
                        };
                        console.time('запись');
                        pic.src = urlFactory.createObjectURL(new Blob([reader.result], {type: "image/jpeg"}));
                    };
                    console.log('file  %s', file.name);
                    console.time('чтение');
                    reader.readAsArrayBuffer(file);
                }

                return  function () {
                    if (n < a)
                    {
                        vvv(failesArray[n++]);
                    }
                    else
                    {
//                        window.close();
                        console.log('eeeeeee');
                        document.getElementById('img').src='';
                        document.getElementById('name_file').innerHTML='';
                        document.getElementById('file').value=null;
                    }
                    return n;
                };
            }


//        -- обрезка --
            $(document).on('click', '#crop_button', function () {
//                    if ($('.cropped').has($('#' + $('#c1').attr('data-v'))).length !== 0)
//                    {
//                        return;
//                    }


//                    if (crop.id === 'full')
//                    {
//                        cropImg |= 2;
//                    }
//                    if (crop.id === 'preview')
//                    {
//                        cropImg |= 1;
//                    }
//                    if (cropImg === 3)
//                    {
                document.getElementById('crop_button').setAttribute('disabled', '');
                $('#save').removeAttr('disabled');
//                    }
                var canvas = document.createElement("canvas");
                var context = canvas.getContext("2d");

                var sq = Math.sqrt(crop.width * crop.width + crop.height * crop.height);

                var x = Math.floor((new_img.x - sq / 2) / img.scale);
                var y = Math.floor((new_img.y - sq / 2) / img.scale);
                var w = Math.floor(sq / img.scale);
                var h = Math.floor(sq / img.scale);

                canvas.height = h;
                canvas.width = w;
                context.fillStyle = '#ffffff';
                context.fillRect(0, 0, w, h);
                context.drawImage(document.getElementById('img'), x, y, w, h, 0, 0, w, h);
                var pic = new Image();
                if (img.scale < 1)
                {
                    pic.onload = pic_load1;
                    pic.src = resize(canvas, sq, sq);
                }
                else
                {
                    pic.onload = pic_load3;
                    pic.src = canvas.toDataURL("image/jpeg", 1.0);
                    function pic_load3() {
                        console.log('n2  w = %s   h = %s', pic.width, pic.height);
                        canvas.height = sq;
                        canvas.width = sq;
                        context.drawImage(pic, 0, 0, sq, sq);
                        pic.onload = pic_load1;
                        pic.src = canvas.toDataURL("image/jpeg", 1.0);
                    }
                }



                function pic_load1() {
                    canvas.height = sq;
                    canvas.width = sq;

                    context.translate(sq / 2, sq / 2);
                    context.rotate((img.rotate * Math.PI) / 180);

                    context.drawImage(pic, -sq / 2, -sq / 2);
                    pic.onload = load_pic2;
                    pic.src = canvas.toDataURL("image/jpeg", 1.0);
                }

                function load_pic2() {
                    canvas.height = crop.height;
                    canvas.width = crop.width;
                    x = (sq - crop.width) / 2;
                    y = (sq - crop.height) / 2;
                    context.drawImage(pic, x, y, crop.width, crop.height, 0, 0, crop.width, crop.height);
                    var k = crop.id === 0 ? 1.0 : 0.75;
                    document.querySelector('.cropped').innerHTML += '<div ><img id="' + crop.id + '" src="' + canvas.toDataURL("image/jpeg", k) + '"></div>';
                    $('#' + crop.id).parent().append('<img src="pic/del.png" class="del"  width="18" height="18" alt="del"/>');
//                        $('#c1').trigger('click');
                }
            });


//        -- пошаговое уменьшение картинки --
            function resize(img, w, h) {
                var steps = Math.ceil(Math.log(img.height / h) / Math.LN2);
                var sW = w * Math.pow(2, steps - 1);
                var sH = h * Math.pow(2, steps - 1);
                while ((steps--))
                {
                    var canvas = document.createElement('canvas');
                    canvas.width = sW;
                    canvas.height = sH;
                    canvas.getContext('2d').drawImage(img, 0, 0, sW, sH);
                    img.src = 'about:blank';
                    img.width = 1;
                    img.height = 1;
                    img = canvas;

                    sW = Math.round(sW / 2);
                    sH = Math.round(sH / 2);
                }
                return canvas.toDataURL("image/jpeg", 1);
            }


//        -- удаление обрезанной картинки --
            $(document).on('click', '.del', function () {
                var t = $(this).parent();
                if ($(t).find('img:first').attr('id') === 'full')
                {
                    cropImg &= ~2;
                }

                if ($(t).find('img:first').attr('id') === 'preview')
                {
                    cropImg &= ~1;
                }
                $('#save').attr('disabled', 'disabled');
                document.getElementById('crop_button').removeAttribute('disabled');
                t.remove();

            });


            var currentCell = 0;
            $(document).on('click', '#save', function () {
//                var element = window.opener.document.getElementsByTagName('my-AirTest')[0];
//                var cellIndex = element.dataset['sample'];
//                var tdr;
//                if (cellIndex !== '-')
//                {
//                    tdr = element.shadowRoot.querySelector('#tbl tbody tr:nth-child(1) td:nth-child(' + (parseInt(cellIndex) + 1) + ')');
//                }
//                else
//                {
//                    tdr = element.shadowRoot.querySelector('#tbl tbody tr:nth-child(1) td:nth-child(' + (++currentCell) + ')');
//
//                }
//                tdr.innerHTML = '<img src="' + document.getElementById('full').getAttribute('src') + '"  data-new="new" style="height: 100%;" />';
////                    var v = $('#img_box_add', window.opener.document);
////                    var w = v.clone();
////                    v.removeAttr('id');
////                    v.attr('data-pic', 'new');
////                    v.append('<img src="' + $('#' + id_crop[0]).attr('src') + '"   height="70"   data-img="' + $('#' + id_crop[1]).attr('src') + '"/>');
////                    v.find('button img').attr('src', 'pic/del.webp');
////                    v.parent().append(w);

                var link = document.createElement("a");

                link.setAttribute("href", document.getElementById('full').getAttribute('src'));
                link.setAttribute("download", "fileName.jpg");
                link.click();
                $('.cropped').empty();
//                $('#c1').trigger('click');
                $('#save').attr('disabled', 'disabled');
                cropImg = 0;
                work();
            });


    </script>

</body>
</html>
